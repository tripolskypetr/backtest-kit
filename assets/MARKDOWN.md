# MARKDOWN Report JSONL Files Documentation

This document describes the markdown report JSONL logging system that tracks generated reports through the `Markdown.writeData()` method.

## Overview

All MarkdownServices write their generated markdown reports to separate JSONL log files located in `./dump/markdown/`. Each log entry contains metadata about when and where a markdown report was generated, along with the full markdown content.

## File Location

All markdown report logs are written to:
```
./dump/markdown/{markdownName}.jsonl
```

Where `{markdownName}` corresponds to the report type (backtest, live, heat, partial, breakeven, schedule, risk, performance, walker, outline).

## JSONL Line Structure

Each line in a markdown JSONL file contains:

```jsonl
{"markdownName":"backtest","data":"# Backtest Report...","symbol":"BTCUSDT","strategyName":"my-strategy","exchangeName":"binance","frameName":"1h","signalId":"","timestamp":1705234567890}
```

### Metadata Fields

- `markdownName`: Report type identifier (backtest, live, heat, etc.)
- `data`: Full markdown report content
- `symbol`: Trading pair symbol (empty string if not applicable)
- `strategyName`: Strategy name (empty string if not applicable)
- `exchangeName`: Exchange name (empty string if not applicable)
- `frameName`: Frame name (empty string if not applicable)
- `signalId`: Signal ID (always empty string for markdown logs)
- `timestamp`: Unix timestamp in milliseconds when report was generated

## Report Types

### 1. backtest.jsonl

> Search keys: `symbol`, `strategyName`, `exchangeName`, `frameName`

Tracks backtest markdown reports with closed signal statistics, performance metrics, and risk analysis.

Report content includes:
- Table of all closed signals with entry/exit prices, PNL, duration
- Total signals count
- Win rate (percentage, win/loss count)
- Average PNL percentage
- Total PNL percentage
- Standard Deviation
- Sharpe Ratio
- Annualized Sharpe Ratio
- Certainty Ratio
- Expected Yearly Returns

Example entry:
```jsonl
{"markdownName":"backtest","data":"# Backtest Report: my-strategy\n\n| Signal ID | ... |\n**Total signals:** 42\n**Win rate:** 65.00%","symbol":"BTCUSDT","strategyName":"my-strategy","exchangeName":"binance","frameName":"1h","signalId":"","timestamp":1705234567890}
```

Generated by: `BacktestMarkdownService.dump()`

### 2. live.jsonl

> Search keys: `symbol`, `strategyName`, `exchangeName`, `frameName`

Tracks live trading markdown reports with real-time signal monitoring.

Report content includes:
- Table of active signals with current status, prices, unrealized PNL
- Table of closed signals with realized PNL
- Win rate and performance statistics
- Current market conditions

Example entry:
```jsonl
{"markdownName":"live","data":"# Live Trading Report: my-strategy\n\n## Active Signals\n| Signal ID | ... |\n## Closed Signals\n| Signal ID | ... |","symbol":"BTCUSDT","strategyName":"my-strategy","exchangeName":"binance","frameName":"","signalId":"","timestamp":1705234567890}
```

Generated by: `LiveMarkdownService.dump()`

### 3. heat.jsonl

> Search keys: `exchangeName`, `frameName`

Tracks portfolio heatmap markdown reports with per-symbol statistics aggregated across all symbols for a strategy.

Report content includes:
- Portfolio-wide summary (total symbols, portfolio PNL, portfolio Sharpe Ratio, total trades)
- Table of per-symbol statistics sorted by Sharpe Ratio:
  - Symbol name
  - Total PNL percentage
  - Sharpe Ratio
  - Maximum Drawdown
  - Total trades count
  - Win/loss counts and win rate
  - Average PNL
  - Standard Deviation
  - Profit Factor
  - Average Win/Loss
  - Max Win/Loss Streaks
  - Expectancy

Example entry:
```jsonl
{"markdownName":"heat","data":"# Portfolio Heatmap: my-strategy\n\n**Total Symbols:** 10 | **Portfolio PNL:** +45.3% | **Portfolio Sharpe:** 1.85\n\n| Symbol | Total PNL | Sharpe | Max DD | Trades |\n| BTCUSDT | +15.5% | 2.10 | -2.5% | 45 |","symbol":"","strategyName":"","exchangeName":"binance","frameName":"1h","signalId":"","timestamp":1705234567890}
```

Generated by: `HeatMarkdownService.dump()`

### 4. partial.jsonl

> Search keys: `symbol`, `strategyName`, `exchangeName`, `frameName`

Tracks partial close markdown reports showing signals where take profit or stop loss was partially closed.

Report content includes:
- Table of profit-side partial closes (when price reached take profit)
- Table of loss-side partial closes (when price reached stop loss)
- Statistics for each side:
  - Total partial close events
  - Average executed percentage
  - Partial vs full close ratio

Example entry:
```jsonl
{"markdownName":"partial","data":"# Partial Close Report: BTCUSDT:my-strategy\n\n## Profit-Side Partial Closes\n| Signal ID | Executed % | ... |\n## Loss-Side Partial Closes\n| Signal ID | Executed % | ... |","symbol":"BTCUSDT","strategyName":"my-strategy","exchangeName":"binance","frameName":"1h","signalId":"","timestamp":1705234567890}
```

Generated by: `PartialMarkdownService.dump()`

### 5. breakeven.jsonl

> Search keys: `symbol`, `strategyName`, `exchangeName`, `frameName`

Tracks breakeven adjustment markdown reports showing when stop loss was moved to entry price after partial take profit close.

Report content includes:
- Table of all breakeven adjustments with:
  - Signal ID and timing
  - Original stop loss price
  - New breakeven stop loss price
  - Take profit execution percentage that triggered breakeven
  - Time elapsed between signal open and breakeven adjustment
- Total breakeven adjustments count
- Average time to breakeven
- Average take profit percentage executed before breakeven

Example entry:
```jsonl
{"markdownName":"breakeven","data":"# Breakeven Report: BTCUSDT:my-strategy\n\n| Signal ID | Original SL | Breakeven SL | TP Executed | Time to BE |\n**Total breakeven adjustments:** 15\n**Average time to breakeven:** 2.5 hours","symbol":"BTCUSDT","strategyName":"my-strategy","exchangeName":"binance","frameName":"1h","signalId":"","timestamp":1705234567890}
```

Generated by: `BreakevenMarkdownService.dump()`

### 6. schedule.jsonl

> Search keys: `symbol`, `strategyName`, `exchangeName`, `frameName`

Tracks scheduled signal markdown reports monitoring pending limit orders and their activation or cancellation.

Report content includes:
- Table of scheduled signals (pending limit orders)
- Table of opened signals (limit orders that activated)
- Table of cancelled signals (limit orders that expired or were rejected)
- Statistics:
  - Total events (scheduled + opened + cancelled)
  - Total scheduled count
  - Total opened count
  - Total cancelled count
  - Cancellation rate percentage
  - Activation rate percentage
  - Average waiting time for cancelled signals
  - Average activation time for opened signals

Example entry:
```jsonl
{"markdownName":"schedule","data":"# Schedule Report: BTCUSDT:my-strategy\n\n## Scheduled Signals\n| Signal ID | Entry Price | ... |\n## Opened Signals\n| Signal ID | Wait Time | ... |\n## Cancelled Signals\n| Signal ID | Reason | Duration |\n**Cancellation rate:** 15.5%\n**Activation rate:** 84.5%","symbol":"BTCUSDT","strategyName":"my-strategy","exchangeName":"binance","frameName":"1h","signalId":"","timestamp":1705234567890}
```

Generated by: `ScheduleMarkdownService.dump()`

### 7. risk.jsonl

> Search keys: `symbol`, `strategyName`, `exchangeName`, `frameName`

Tracks risk rejection markdown reports showing signals that were rejected due to risk management limits.

Report content includes:
- Table of all risk rejection events with:
  - Timestamp
  - Symbol
  - Strategy name
  - Rejection reason (max concurrent positions, max loss limit, insufficient margin, etc.)
  - Signal details that were rejected
- Total rejections count
- Rejections by symbol breakdown
- Rejections by strategy breakdown

Example entry:
```jsonl
{"markdownName":"risk","data":"# Risk Rejection Report: BTCUSDT:my-strategy\n\n| Timestamp | Symbol | Strategy | Reason |\n**Total rejections:** 5\n\n## Rejections by Symbol\n- BTCUSDT: 3\n- ETHUSDT: 2\n\n## Rejections by Strategy\n- my-strategy: 5","symbol":"BTCUSDT","strategyName":"my-strategy","exchangeName":"binance","frameName":"1h","signalId":"","timestamp":1705234567890}
```

Generated by: `RiskMarkdownService.dump()`

### 8. performance.jsonl

> Search keys: `symbol`, `strategyName`, `exchangeName`, `frameName`

Tracks performance metrics markdown reports analyzing execution bottlenecks and timing data.

Report content includes:
- Total events count and total execution time
- Time distribution breakdown (percentage of total time per metric type)
- Detailed metrics table with:
  - Metric type (strategy execution, data fetch, indicator calculation, etc.)
  - Event count
  - Total duration
  - Average duration
  - Min/Max duration
  - Standard Deviation
  - Median, P95, P99 response times
  - Average/Min/Max wait times between events
- Performance bottleneck analysis

Example entry:
```jsonl
{"markdownName":"performance","data":"# Performance Report: my-strategy\n\n**Total events:** 1000\n**Total execution time:** 45678.90ms\n\n## Time Distribution\n- strategy_execution: 65.5% (29890.12ms total)\n\n## Detailed Metrics\n| Metric | Count | Avg | P95 | P99 |","symbol":"BTCUSDT","strategyName":"my-strategy","exchangeName":"binance","frameName":"1h","signalId":"","timestamp":1705234567890}
```

Generated by: `PerformanceMarkdownService.dump()`

### 9. walker.jsonl

> Search keys: `symbol`, `exchangeName`, `frameName`

Tracks walker optimization markdown reports comparing multiple strategy parameter combinations.

Report content includes:
- Best strategy summary with optimization metric value
- Top strategies comparison table showing:
  - Strategy name (parameter combination)
  - Metric value being optimized
  - Total signals
  - Win rate
  - Total PNL
  - Sharpe Ratio
  - Other performance metrics
- All signals PNL table across all tested strategies with:
  - Strategy name
  - Signal ID
  - Symbol
  - Position type
  - PNL percentage
  - Close reason
  - Open/close timestamps

Example entry:
```jsonl
{"markdownName":"walker","data":"# Walker Comparison Report: my-walker\n\n**Symbol:** BTCUSDT\n**Optimization Metric:** sharpeRatio\n**Strategies Tested:** 100\n\n## Best Strategy: strategy_42\n**Best sharpeRatio:** 2.15\n\n## Top Strategies Comparison\n| Strategy | Sharpe | Win Rate | Total PNL |\n\n## All Signals (PNL Table)\n| Strategy | Signal | PNL % |","symbol":"BTCUSDT","strategyName":"","exchangeName":"binance","frameName":"1h","signalId":"","timestamp":1705234567890}
```

Generated by: `WalkerMarkdownService.dump()`

### 10. outline.jsonl

> Search keys: `signalId`

Tracks LLM conversation markdown files for AI Strategy Optimizer debug logs.

Report content includes:
- System prompt with result ID and output data
- User messages from conversation history
- Final LLM output with signal parameters

Special characteristics:
- Multiple JSONL entries per iteration (3+ lines per signal)
- Each entry represents a separate markdown file
- Files organized in subdirectories: `./dump/outline/{signalId}/`
- File types:
  - `00_system_prompt.md`: System messages and output summary
  - `XX_user_message.md`: Each user input in numbered files
  - `XX_llm_output.md`: Final LLM response with signal data

Example entries (multiple lines per signal):
```jsonl
{"markdownName":"outline","data":"# Outline Result Summary\n\n**ResultId**: strategy-1\n\n## Output Data\n```json\n{...}\n```","symbol":"","signalId":"strategy-1","strategyName":"","exchangeName":"","frameName":"","timestamp":1705234567890}
{"markdownName":"outline","data":"# User Input 1\n\n**ResultId**: strategy-1\n\nGenerate a long strategy...","symbol":"","signalId":"strategy-1","strategyName":"","exchangeName":"","frameName":"","timestamp":1705234567891}
{"markdownName":"outline","data":"# Full Outline Result\n\n**ResultId**: strategy-1\n\n## Output Data\n```json\n{...}\n```","symbol":"","signalId":"strategy-1","strategyName":"","exchangeName":"","frameName":"","timestamp":1705234567892}
```

Generated by: `OutlineMarkdownService.dumpSignal()`

## Implementation Details

### Markdown.writeData() Method

All MarkdownServices use the `Markdown.writeData()` static method from `src/classes/Markdown.ts`:

```typescript
await Markdown.writeData(markdownName, markdownContent, {
  path: "./dump/reports",           // Directory for .md file
  file: "report-timestamp.md",      // Markdown filename
  symbol: "BTCUSDT",                // Search metadata
  strategyName: "my-strategy",      // Search metadata
  exchangeName: "binance",          // Search metadata
  frameName: "1h",                  // Search metadata
  signalId: "",                     // Always empty for markdown logs
});
```

### File Writing Behavior

1. Appends JSONL line to `./dump/markdown/{markdownName}.jsonl`
2. Writes full markdown report to `{path}/{file}`
3. Creates directories automatically if they don't exist
4. Uses WriteStream with backpressure handling
5. 15-second timeout protection per write operation
6. JSONL file remains append-only for historical tracking

### Empty String Handling

Unlike event logs (backtest.jsonl, live.jsonl, etc.), markdown logs include all metadata fields even when empty:
- `symbol`: Empty string when report is portfolio-wide (heat, outline)
- `strategyName`: Empty string when report is portfolio-wide (heat, walker, outline)
- `signalId`: Always empty string except for outline (uses signalId for grouping conversation files)
- `exchangeName`: Empty string for outline
- `frameName`: Empty string for live trading and outline

All fields are always included in JSONL output regardless of value.

## Use Cases

### Audit Trail

Track when reports were generated and what data they contained:
```bash
# Find all backtest reports generated in the last hour
grep "backtest" ./dump/markdown/backtest.jsonl | jq 'select(.timestamp > (now - 3600) * 1000)'
```

### Report History

Review historical report snapshots:
```bash
# Extract markdown content from a specific timestamp
grep "1705234567890" ./dump/markdown/backtest.jsonl | jq -r '.data' > historical-report.md
```

### Debugging

Verify report generation and content:
```bash
# Check if reports are being generated for a strategy
grep "my-strategy" ./dump/markdown/*.jsonl | wc -l

# View latest generated report
tail -n 1 ./dump/markdown/backtest.jsonl | jq '.data'
```

### Analytics

Analyze report generation patterns:
```bash
# Count reports per strategy
jq -r '.strategyName' ./dump/markdown/backtest.jsonl | sort | uniq -c

# Find strategies with most risk rejections
jq -r '.strategyName' ./dump/markdown/risk.jsonl | sort | uniq -c | sort -rn
```

## Differences from Event Logs

### Event Logs (Report.writeData)
- Location: `./dump/reports/{reportName}.jsonl`
- Purpose: Track individual trading events (signal opened, closed, scheduled, etc.)
- Granularity: One event per JSONL line
- Content: Event-specific data (prices, PNL, timestamps)
- Search keys: Non-empty strings for filtering

### Markdown Logs (Markdown.writeData)
- Location: `./dump/markdown/{markdownName}.jsonl`
- Purpose: Track generated markdown reports
- Granularity: One report per JSONL line
- Content: Full markdown report text in `data` field
- Search keys: May contain empty strings (portfolio reports)

Both systems run independently - events are logged as they occur, while markdown reports are generated on demand via `.dump()` methods.
